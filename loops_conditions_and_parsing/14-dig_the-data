#!/usr/bin/env bash
# This script groups visitors by IP and HTTP status code and displays the data.
# It handles small, large, and incorrectly formatted log files.

# Define the log file name
LOG_FILE="apache-access.log"

# Check if the log file exists and is not empty
if [ ! -s "$LOG_FILE" ]; then
    echo "Log file is either empty or does not exist."
    exit 1  # Exit with an error code if the log file is empty or does not exist
fi

# Parse the log file, handle small and large logs, and skip incorrect format lines
awk '{
    if (NF >= 9 && $1 ~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/ && $9 ~ /^[0-9]+$/) {  # Ensure the line has at least 9 fields, a valid IP, and status code
        count[$1 " " $9]++  # Group by IP and HTTP status code
    } else {
        next 
    }
}
END {
    for (entry in count) {
        print count[entry], entry  # Print occurrences, IP, and HTTP code
    }
}' "$LOG_FILE" | sort -nr  # Sort in reverse order by occurrence number

